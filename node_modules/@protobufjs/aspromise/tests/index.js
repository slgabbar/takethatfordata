var tape = require("tape");

var asPromise = require("..");

tape.test("aspromise", function(test) ***REMOVED***

    test.test(this.name + " - resolve", function(test) ***REMOVED***

        function fn(arg1, arg2, callback) ***REMOVED***
            test.equal(this, ctx, "function should be called with this = ctx");
            test.equal(arg1, 1, "function should be called with arg1 = 1");
            test.equal(arg2, 2, "function should be called with arg2 = 2");
            callback(null, arg2);
        ***REMOVED***

        var ctx = ***REMOVED******REMOVED***;

        var promise = asPromise(fn, ctx, 1, 2);
        promise.then(function(arg2) ***REMOVED***
            test.equal(arg2, 2, "promise should be resolved with arg2 = 2");
            test.end();
        ***REMOVED***).catch(function(err) ***REMOVED***
            test.fail("promise should not be rejected (" + err + ")");
        ***REMOVED***);
    ***REMOVED***);

    test.test(this.name + " - reject", function(test) ***REMOVED***

        function fn(arg1, arg2, callback) ***REMOVED***
            test.equal(this, ctx, "function should be called with this = ctx");
            test.equal(arg1, 1, "function should be called with arg1 = 1");
            test.equal(arg2, 2, "function should be called with arg2 = 2");
            callback(arg1);
        ***REMOVED***

        var ctx = ***REMOVED******REMOVED***;

        var promise = asPromise(fn, ctx, 1, 2);
        promise.then(function() ***REMOVED***
            test.fail("promise should not be resolved");
        ***REMOVED***).catch(function(err) ***REMOVED***
            test.equal(err, 1, "promise should be rejected with err = 1");
            test.end();
        ***REMOVED***);
    ***REMOVED***);

    test.test(this.name + " - resolve twice", function(test) ***REMOVED***

        function fn(arg1, arg2, callback) ***REMOVED***
            test.equal(this, ctx, "function should be called with this = ctx");
            test.equal(arg1, 1, "function should be called with arg1 = 1");
            test.equal(arg2, 2, "function should be called with arg2 = 2");
            callback(null, arg2);
            callback(null, arg1);
        ***REMOVED***

        var ctx = ***REMOVED******REMOVED***;
        var count = 0;

        var promise = asPromise(fn, ctx, 1, 2);
        promise.then(function(arg2) ***REMOVED***
            test.equal(arg2, 2, "promise should be resolved with arg2 = 2");
            if (++count > 1)
                test.fail("promise should not be resolved twice");
            test.end();
        ***REMOVED***).catch(function(err) ***REMOVED***
            test.fail("promise should not be rejected (" + err + ")");
        ***REMOVED***);
    ***REMOVED***);

    test.test(this.name + " - reject twice", function(test) ***REMOVED***

        function fn(arg1, arg2, callback) ***REMOVED***
            test.equal(this, ctx, "function should be called with this = ctx");
            test.equal(arg1, 1, "function should be called with arg1 = 1");
            test.equal(arg2, 2, "function should be called with arg2 = 2");
            callback(arg1);
            callback(arg2);
        ***REMOVED***

        var ctx = ***REMOVED******REMOVED***;
        var count = 0;

        var promise = asPromise(fn, ctx, 1, 2);
        promise.then(function() ***REMOVED***
            test.fail("promise should not be resolved");
        ***REMOVED***).catch(function(err) ***REMOVED***
            test.equal(err, 1, "promise should be rejected with err = 1");
            if (++count > 1)
                test.fail("promise should not be rejected twice");
            test.end();
        ***REMOVED***);
    ***REMOVED***);

    test.test(this.name + " - reject error", function(test) ***REMOVED***

        function fn(callback) ***REMOVED***
            test.ok(arguments.length === 1 && typeof callback === "function", "function should be called with just a callback");
            throw 3;
        ***REMOVED***

        var promise = asPromise(fn, null);
        promise.then(function() ***REMOVED***
            test.fail("promise should not be resolved");
        ***REMOVED***).catch(function(err) ***REMOVED***
            test.equal(err, 3, "promise should be rejected with err = 3");
            test.end();
        ***REMOVED***);
    ***REMOVED***);

    test.test(this.name + " - reject and error", function(test) ***REMOVED***

        function fn(callback) ***REMOVED***
            callback(3);
            throw 4;
        ***REMOVED***

        var count = 0;

        var promise = asPromise(fn, null);
        promise.then(function() ***REMOVED***
            test.fail("promise should not be resolved");
        ***REMOVED***).catch(function(err) ***REMOVED***
            test.equal(err, 3, "promise should be rejected with err = 3");
            if (++count > 1)
                test.fail("promise should not be rejected twice");
            test.end();
        ***REMOVED***);
    ***REMOVED***);
***REMOVED***);
