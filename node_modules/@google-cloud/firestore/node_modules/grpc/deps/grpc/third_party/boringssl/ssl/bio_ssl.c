/*
 * Copyright 1995-2016 The OpenSSL Project Authors. All Rights Reserved.
 *
 * Licensed under the OpenSSL license (the "License").  You may not use
 * this file except in compliance with the License.  You can obtain a copy
 * in the file LICENSE in the source distribution or at
 * https://www.openssl.org/source/license.html
 */

#include <openssl/ssl.h>

#include <openssl/bio.h>


static int ssl_read(BIO *bio, char *out, int outl) ***REMOVED***
  SSL *ssl = bio->ptr;
  if (ssl == NULL) ***REMOVED***
    return 0;
  ***REMOVED***

  BIO_clear_retry_flags(bio);

  const int ret = SSL_read(ssl, out, outl);

  switch (SSL_get_error(ssl, ret)) ***REMOVED***
    case SSL_ERROR_WANT_READ:
      BIO_set_retry_read(bio);
      break;

    case SSL_ERROR_WANT_WRITE:
      BIO_set_retry_write(bio);
      break;

    case SSL_ERROR_WANT_ACCEPT:
      BIO_set_retry_special(bio);
      bio->retry_reason = BIO_RR_ACCEPT;
      break;

    case SSL_ERROR_WANT_CONNECT:
      BIO_set_retry_special(bio);
      bio->retry_reason = BIO_RR_CONNECT;
      break;

    case SSL_ERROR_NONE:
    case SSL_ERROR_SYSCALL:
    case SSL_ERROR_SSL:
    case SSL_ERROR_ZERO_RETURN:
    default:
      break;
  ***REMOVED***

  return ret;
***REMOVED***

static int ssl_write(BIO *bio, const char *out, int outl) ***REMOVED***
  SSL *ssl = bio->ptr;
  if (ssl == NULL) ***REMOVED***
    return 0;
  ***REMOVED***

  BIO_clear_retry_flags(bio);

  const int ret = SSL_write(ssl, out, outl);

  switch (SSL_get_error(ssl, ret)) ***REMOVED***
    case SSL_ERROR_WANT_WRITE:
      BIO_set_retry_write(bio);
      break;

    case SSL_ERROR_WANT_READ:
      BIO_set_retry_read(bio);
      break;

    case SSL_ERROR_WANT_CONNECT:
      BIO_set_retry_special(bio);
      bio->retry_reason = BIO_RR_CONNECT;
      break;

    case SSL_ERROR_NONE:
    case SSL_ERROR_SYSCALL:
    case SSL_ERROR_SSL:
    default:
      break;
  ***REMOVED***

  return ret;
***REMOVED***

static long ssl_ctrl(BIO *bio, int cmd, long num, void *ptr) ***REMOVED***
  SSL *ssl = bio->ptr;
  if (ssl == NULL && cmd != BIO_C_SET_SSL) ***REMOVED***
    return 0;
  ***REMOVED***

  switch (cmd) ***REMOVED***
    case BIO_C_SET_SSL:
      bio->shutdown = num;
      bio->ptr = ptr;
      bio->init = 1;
      return 1;

    case BIO_CTRL_GET_CLOSE:
      return bio->shutdown;

    case BIO_CTRL_SET_CLOSE:
      bio->shutdown = num;
      return 1;

    case BIO_CTRL_WPENDING:
      return BIO_ctrl(SSL_get_wbio(ssl), cmd, num, ptr);

    case BIO_CTRL_PENDING:
      return SSL_pending(ssl);

    case BIO_CTRL_FLUSH: ***REMOVED***
      BIO_clear_retry_flags(bio);
      long ret = BIO_ctrl(SSL_get_wbio(ssl), cmd, num, ptr);
      BIO_copy_next_retry(bio);
      return ret;
    ***REMOVED***

    case BIO_CTRL_PUSH:
    case BIO_CTRL_POP:
    case BIO_CTRL_DUP:
      return -1;

    default:
      return BIO_ctrl(SSL_get_rbio(ssl), cmd, num, ptr);
  ***REMOVED***
***REMOVED***

static int ssl_new(BIO *bio) ***REMOVED***
  return 1;
***REMOVED***

static int ssl_free(BIO *bio) ***REMOVED***
  SSL *ssl = bio->ptr;

  if (ssl == NULL) ***REMOVED***
    return 1;
  ***REMOVED***

  SSL_shutdown(ssl);
  if (bio->shutdown) ***REMOVED***
    SSL_free(ssl);
  ***REMOVED***

  return 1;
***REMOVED***

static long ssl_callback_ctrl(BIO *bio, int cmd, bio_info_cb fp) ***REMOVED***
  SSL *ssl = bio->ptr;
  if (ssl == NULL) ***REMOVED***
    return 0;
  ***REMOVED***

  switch (cmd) ***REMOVED***
    case BIO_CTRL_SET_CALLBACK:
      return -1;

    default:
      return BIO_callback_ctrl(SSL_get_rbio(ssl), cmd, fp);
  ***REMOVED***
***REMOVED***

static const BIO_METHOD ssl_method = ***REMOVED***
    BIO_TYPE_SSL, "SSL",    ssl_write, ssl_read, NULL,
    NULL,         ssl_ctrl, ssl_new,   ssl_free, ssl_callback_ctrl,
***REMOVED***;

const BIO_METHOD *BIO_f_ssl(void) ***REMOVED*** return &ssl_method; ***REMOVED***

long BIO_set_ssl(BIO *bio, SSL *ssl, int take_owership) ***REMOVED***
  return BIO_ctrl(bio, BIO_C_SET_SSL, take_owership, ssl);
***REMOVED***
