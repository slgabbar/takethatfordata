/*
 *
 * Copyright 2016 gRPC authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

#ifndef GRPC_CORE_LIB_TRANSPORT_PID_CONTROLLER_H
#define GRPC_CORE_LIB_TRANSPORT_PID_CONTROLLER_H

#include <limits>

/* \file Simple PID controller.
   Implements a proportional-integral-derivative controller.
   Used when we want to iteratively control a variable to converge some other
   observed value to a 'set-point'.
   Gains can be set to adjust sensitivity to current error (p), the integral
   of error (i), and the derivative of error (d). */

namespace grpc_core ***REMOVED***

class PidController ***REMOVED***
 public:
  class Args ***REMOVED***
   public:
    double gain_p() const ***REMOVED*** return gain_p_; ***REMOVED***
    double gain_i() const ***REMOVED*** return gain_i_; ***REMOVED***
    double gain_d() const ***REMOVED*** return gain_d_; ***REMOVED***
    double initial_control_value() const ***REMOVED*** return initial_control_value_; ***REMOVED***
    double min_control_value() const ***REMOVED*** return min_control_value_; ***REMOVED***
    double max_control_value() const ***REMOVED*** return max_control_value_; ***REMOVED***
    double integral_range() const ***REMOVED*** return integral_range_; ***REMOVED***

    Args& set_gain_p(double gain_p) ***REMOVED***
      gain_p_ = gain_p;
      return *this;
    ***REMOVED***
    Args& set_gain_i(double gain_i) ***REMOVED***
      gain_i_ = gain_i;
      return *this;
    ***REMOVED***
    Args& set_gain_d(double gain_d) ***REMOVED***
      gain_d_ = gain_d;
      return *this;
    ***REMOVED***
    Args& set_initial_control_value(double initial_control_value) ***REMOVED***
      initial_control_value_ = initial_control_value;
      return *this;
    ***REMOVED***
    Args& set_min_control_value(double min_control_value) ***REMOVED***
      min_control_value_ = min_control_value;
      return *this;
    ***REMOVED***
    Args& set_max_control_value(double max_control_value) ***REMOVED***
      max_control_value_ = max_control_value;
      return *this;
    ***REMOVED***
    Args& set_integral_range(double integral_range) ***REMOVED***
      integral_range_ = integral_range;
      return *this;
    ***REMOVED***

   private:
    double gain_p_ = 0.0;
    double gain_i_ = 0.0;
    double gain_d_ = 0.0;
    double initial_control_value_ = 0.0;
    double min_control_value_ = std::numeric_limits<double>::min();
    double max_control_value_ = std::numeric_limits<double>::max();
    double integral_range_ = std::numeric_limits<double>::max();
  ***REMOVED***;

  explicit PidController(const Args& args);

  /// Reset the controller internal state: useful when the environment has
  /// changed significantly
  void Reset() ***REMOVED***
    last_error_ = 0.0;
    last_dc_dt_ = 0.0;
    error_integral_ = 0.0;
  ***REMOVED***

  /// Update the controller: given a current error estimate, and the time since
  /// the last update, returns a new control value
  double Update(double error, double dt);

  /// Returns the last control value calculated
  double last_control_value() const ***REMOVED*** return last_control_value_; ***REMOVED***

  /// Returns the current error integral (mostly for testing)
  double error_integral() const ***REMOVED*** return error_integral_; ***REMOVED***

 private:
  double last_error_ = 0.0;
  double error_integral_ = 0.0;
  double last_control_value_;
  double last_dc_dt_ = 0.0;
  const Args args_;
***REMOVED***;

***REMOVED***  // namespace grpc_core

#endif /* GRPC_CORE_LIB_TRANSPORT_PID_CONTROLLER_H */
