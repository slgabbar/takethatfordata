//?...
// Welcome to the crazy world of MetaScript! Tell it what you need, it will not moan, and there it is.

// Substitute for the backing buffer's capacity
CAPACITY = NODE ? 'this.buffer.length' : 'this.buffer.byteLength';

// Asserts that a variable is an integer
ASSERT_INTEGER = function(varValue, unsigned) ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// <ASSERT_INTEGER>');
    if (INLINE) ***REMOVED***
        writeln(__+'if (typeof '+varValue+' !== \'number\' || '+varValue+' % 1 !== 0)');
        writeln(__+'    throw TypeError("Illegal '+varValue+': "+'+varValue+'+" (not an integer)");');
        writeln(__+varValue+' '+(unsigned ? '>>>' : '|')+'= 0;');
    ***REMOVED*** else ***REMOVED***
        writeln(__+varValue+' = assertInteger('+varValue+(typeof unsigned !== 'undefined' ? ', '+unsigned : '')+');');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </ASSERT_INTEGER>');
***REMOVED***;

// Asserts that a variable is a number or Long
ASSERT_LONG = function(varValue, unsigned) ***REMOVED***
    if (typeof varValue === 'undefined') varValue = 'value';
    if (VERBOSE_MS) writeln(__+'// <ASSERT_LONG>');
    if (INLINE) ***REMOVED***
        writeln(__+'if (typeof '+varValue+' === \'number\')');
        writeln(__+'    '+varValue+' = Long.fromNumber('+varValue+');');
        writeln(__+'else if (typeof '+varValue+' === \'string\')');
        writeln(__+'    '+varValue+' = Long.fromString('+varValue+');');
        if (typeof unsigned !== 'undefined') ***REMOVED*** // When explicitly specified only
            writeln(__+'else if ('+varValue+' && '+varValue+' instanceof Long)');
            if (unsigned) ***REMOVED***
                writeln(__+'    if (!'+varValue+'.unsigned) '+varValue+' = '+varValue+'.toUnsigned();');
            ***REMOVED*** else ***REMOVED***
                writeln(__+'    if ('+varValue+'.unsigned) '+varValue+' = '+varValue+'.toSigned();');
            ***REMOVED***
            writeln(__+'else');
        ***REMOVED*** else ***REMOVED***
            writeln(__+'else if (!('+varValue+' && '+varValue+' instanceof Long))');
        ***REMOVED***
        writeln(__+'    throw TypeError("Illegal '+varValue+': "+'+varValue+'+" (not an integer or Long)");');
    ***REMOVED*** else ***REMOVED***
        writeln(__+varValue+' = assertLong('+varValue+(typeof unsigned !== 'undefined' ? ', '+unsigned : '')+');');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </ASSERT_LONG>');
***REMOVED***;

// Casts a variable to a Long if necessary
LONG = function(varValue, unsigned) ***REMOVED***
    if (typeof varValue === 'undefined') varValue = 'value';
    if (VERBOSE_MS) writeln(__+'// <LONG'+(typeof unsigned === 'boolean' ? ' unsigned='+unsigned : '')+'>');
    writeln(__+'if (typeof '+varValue+' === \'number\')');
    writeln(__+'    '+varValue+' = Long.fromNumber('+varValue+(typeof unsigned === 'boolean' ? ', '+unsigned : '')+');');
    writeln(__+'else if (typeof '+varValue+' === \'string\')');
    writeln(__+'    '+varValue+' = Long.fromString('+varValue+(typeof unsigned === 'boolean' ? ', '+unsigned : '')+');');
    if (typeof unsigned === 'boolean') ***REMOVED***
        writeln(__+'else if ('+varValue+'.unsigned !== '+unsigned+') '+varValue+' = '+varValue+'.'+(unsigned ? 'toUnsigned' : 'toSigned')+'();');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </LONG>');
***REMOVED***;

// Asserts that an offset is valid
ASSERT_OFFSET = function(size, varOffset) ***REMOVED***
    if (typeof size      === 'undefined') size      = 0;
    if (typeof varOffset === 'undefined') varOffset = 'offset';
    if (VERBOSE_MS) writeln(__+'// <ASSERT_OFFSET>');
    if (INLINE) ***REMOVED***
        writeln(__+'if (typeof '+varOffset+' !== \'number\' || '+varOffset+' % 1 !== 0)');
        writeln(__+'    throw TypeError("Illegal '+varOffset+': "+'+varOffset+'+" (not an integer)");');
        writeln(__+varOffset+' >>>= 0;');
        writeln(__+'if ('+varOffset+' < 0 || '+varOffset+' + '+size+' > '+CAPACITY+')');
        writeln(__+'    throw RangeError("Illegal '+varOffset+': 0 <= "+'+varOffset+'+" (+"+'+size+'+") <= "+'+CAPACITY+');');
    ***REMOVED*** else ***REMOVED***
        writeln(__+varOffset+' = assertOffset('+varOffset+', 0, '+CAPACITY+', '+size+');');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </ASSERT_OFFSET>');
***REMOVED***;

// Asserts that a range is valid
ASSERT_RANGE = function(varBegin, varEnd) ***REMOVED***
    if (typeof varBegin === 'undefined') varBegin = 'begin';
    if (typeof varEnd   === 'undefined') varEnd   = 'end';
    if (VERBOSE_MS) writeln(__+'// <ASSERT_RANGE>');
    if (INLINE) ***REMOVED***
        writeln(__+'if (typeof '+varBegin+' !== \'number\' || '+varBegin+' % 1 !== 0)');
        writeln(__+'    throw TypeError("Illegal '+varBegin+': Not an integer");');
        writeln(__+varBegin+' >>>= 0;');
        writeln(__+'if (typeof '+varEnd+' !== \'number\' || '+varEnd+' % 1 !== 0)');
        writeln(__+'    throw TypeError("Illegal '+varEnd+': Not an integer");');
        writeln(__+varEnd+' >>>= 0;');
        writeln(__+'if ('+varBegin+' < 0 || '+varBegin+' > '+varEnd+' || '+varEnd+' > '+CAPACITY+')');
        writeln(__+'    throw RangeError("Illegal range: 0 <= "+'+varBegin+'+" <= "+'+varEnd+'+" <= "+'+CAPACITY+');');
    ***REMOVED*** else ***REMOVED***
        writeln(__+'assertRange('+varBegin+', '+varEnd+', 0, '+CAPACITY+');');
        writeln(__+varBegin+' = rangeVal[0]; '+varEnd+' = rangeVal[1];');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </ASSERT_RANGE>');
***REMOVED***;

// ENSURE_CAPACITY counter in case that multiple calls are used in a single method
var ECN = 0;

// Ensures that a ByteBuffer is backed by a buffer that takes `size` additional capacity
ENSURE_CAPACITY = function(size, varOffset) ***REMOVED***
    if (typeof varOffset === 'undefined') varOffset = 'offset';
    if (VERBOSE_MS) writeln(__+'// <ENSURE_CAPACITY size='+size+'>');
    if (INLINE) ***REMOVED***
        writeln(__+varOffset+' += '+size+';');
        writeln(__+'var capacity'+ECN+' = '+CAPACITY+';');
        writeln(__+'if ('+varOffset+' > capacity'+ECN+')');
        writeln(__+'    this.resize((capacity'+ECN+' *= 2) > '+varOffset+' ? capacity'+ECN+' : '+varOffset+');');
        writeln(__+varOffset+' -= '+size+';');
    ***REMOVED*** else ***REMOVED***
        writeln(__+'this.ensureCapacity('+varOffset+'+'+size+');');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </ENSURE_CAPACITY>');
    ++ECN;
***REMOVED***;

// Sets up a relative operation if `size` is omitted, else increases offset by `size`
RELATIVE = function(size, varOffset, varRelOffset) ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// <RELATIVE'+(typeof size !== 'undefined' ? ' size='+size : '')+'>');
    if (typeof size === 'undefined') ***REMOVED***
        if (typeof varOffset === 'undefined') varOffset = "offset";
        if (typeof varRelOffset === 'undefined') varRelOffset = "this.offset";
        writeln(__+'var relative = typeof '+varOffset+' === \'undefined\';');
        writeln(__+'if (relative) '+varOffset+' = '+varRelOffset+';');
    ***REMOVED*** else ***REMOVED***
        if (typeof varOffset === 'undefined') varOffset = "this.offset";
        writeln(__+'if (relative) this.offset += '+size+';');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </RELATIVE>');
***REMOVED***;

// Reads an uint32 from an array
READ_UINT32_ARRAY = function(varValue, varOffset, varTarget, varEndian) ***REMOVED***
    if (typeof varValue  === 'undefined') varValue = 'value';
    if (typeof varOffset === 'undefined') varOffset = 'offset';
    if (typeof varTarget === 'undefined') varTarget = NODE ? 'this.buffer' : 'this.view';
    var ____ = typeof varEndian !== 'boolean' ? '    ' : '';
    if (VERBOSE_MS) writeln(__+'// <READ_UINT32'+(typeof varEndian === 'boolean' ? ' le='+varEndian : '')+'>');
    if (NODE || !DATAVIEW) ***REMOVED***
        if (typeof varEndian !== 'boolean')
            writeln(__+'if ('+(varEndian || 'this.littleEndian')+') ***REMOVED***');
        if (typeof varEndian !== 'boolean' || varEndian === true) ***REMOVED***
            writeln(__+____+varValue+'  = '+varTarget+'['+varOffset+'+2] << 16;');
            writeln(__+____+varValue+' |= '+varTarget+'['+varOffset+'+1] <<  8;');
            writeln(__+____+varValue+' |= '+varTarget+'['+varOffset+'  ];');
            writeln(__+____+varValue+' += '+varTarget+'['+varOffset+'+3] << 24 >>> 0;');
        ***REMOVED***
        if (typeof varEndian !== 'boolean')
            writeln(__+'***REMOVED*** else ***REMOVED***');
        if (typeof varEndian !== 'boolean' || varEndian === false) ***REMOVED***
            writeln(__+____+varValue+'  = '+varTarget+'['+varOffset+'+1] << 16;');
            writeln(__+____+varValue+' |= '+varTarget+'['+varOffset+'+2] <<  8;');
            writeln(__+____+varValue+' |= '+varTarget+'['+varOffset+'+3];');
            writeln(__+____+varValue+' += '+varTarget+'['+varOffset+'  ] << 24 >>> 0;');
        ***REMOVED***
        if (typeof varEndian !== 'boolean')
            writeln(__+'***REMOVED***');
    ***REMOVED*** else ***REMOVED***
        writeln(__+varTarget+'.getUint32('+varOffset+', '+varEndian+');');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </READ_UINT32>');
***REMOVED***;

// Writes an uint32 to an array
WRITE_UINT32_ARRAY = function(varValue, varOffset, varTarget, varEndian) ***REMOVED***
    if (typeof varValue  === 'undefined') varValue = 'value';
    if (typeof varOffset === 'undefined') varOffset = 'offset';
    if (typeof varTarget === 'undefined') varTarget = NODE ? 'this.buffer' : 'this.view';
    var ____ = typeof varEndian !== 'boolean' ? '    ' : '';
    if (VERBOSE_MS) writeln(__+'// <WRITE_UINT32'+(typeof varEndian === 'boolean' ? ' le='+varEndian : '')+'>');
    if (NODE || !DATAVIEW) ***REMOVED***
        if (typeof varEndian !== 'boolean')
            writeln(__+'if ('+(varEndian || 'this.littleEndian')+') ***REMOVED***');
        if (typeof varEndian !== 'boolean' || varEndian === true) ***REMOVED***
            writeln(__+____+varTarget+'['+varOffset+'+3] = ('+varValue+' >>> 24) & 0xFF;');
            writeln(__+____+varTarget+'['+varOffset+'+2] = ('+varValue+' >>> 16) & 0xFF;');
            writeln(__+____+varTarget+'['+varOffset+'+1] = ('+varValue+' >>>  8) & 0xFF;');
            writeln(__+____+varTarget+'['+varOffset+'  ] =  '+varValue+'         & 0xFF;');
        ***REMOVED***
        if (typeof varEndian !== 'boolean')
            writeln(__+'***REMOVED*** else ***REMOVED***');
        if (typeof varEndian !== 'boolean' || varEndian === false) ***REMOVED***
            writeln(__+____+varTarget+'['+varOffset+'  ] = ('+varValue+' >>> 24) & 0xFF;');
            writeln(__+____+varTarget+'['+varOffset+'+1] = ('+varValue+' >>> 16) & 0xFF;');
            writeln(__+____+varTarget+'['+varOffset+'+2] = ('+varValue+' >>>  8) & 0xFF;');
            writeln(__+____+varTarget+'['+varOffset+'+3] =  '+varValue+'         & 0xFF;');
        ***REMOVED***
        if (typeof varEndian !== 'boolean')
            writeln(__+'***REMOVED***');
    ***REMOVED*** else ***REMOVED***
        writeln(__+varTarget+'.setUint32('+varValue+', '+varOffset+', '+varEndian+');');
    ***REMOVED***
    if (VERBOSE_MS) writeln(__+'// </WRITE_UINT32>');
***REMOVED***;

SET = function(varValue, varOffset, varTarget) ***REMOVED*** // with varTarget referencing a ByteBuffer
    if (typeof varValue  === 'undefined') varValue = 'value';
    if (typeof varOffset === 'undefined') varOffset = 'offset';
    if (typeof varTarget === 'undefined') varTarget = 'this';
    if (NODE) ***REMOVED***
        writeln(__+varTarget+'.buffer['+varOffset+'] = '+varValue+';');
    ***REMOVED*** else if (DATAVIEW) ***REMOVED***
        writeln(__+varTarget+'.view.setUint8('+varValue+', '+varOffset+');');
    ***REMOVED*** else ***REMOVED***
        writeln(__+varTarget+'.view['+varOffset+'] = '+varValue+';');
    ***REMOVED***
***REMOVED***;

GET = function(varOffset, varTarget) ***REMOVED*** // with varTarget referencing a ByteBuffer
    if (typeof varOffset === 'undefined') varOffset = 'offset';
    if (typeof varTarget === 'undefined') varTarget = 'this';
    if (NODE) ***REMOVED***
        write(varTarget+'.buffer['+varOffset+']');
    ***REMOVED*** else if (DATAVIEW) ***REMOVED***
        write(varTarget+'.view.getUint8('+varOffset+')');
    ***REMOVED*** else ***REMOVED***
        write(varTarget+'.view['+varOffset+']');
    ***REMOVED***
***REMOVED***;
//?.